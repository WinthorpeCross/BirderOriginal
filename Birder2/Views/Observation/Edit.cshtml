@model Birder2.ViewModels.EditObservationViewModel

@{
    ViewData["Title"] = "Edit";
}

<h1>@Model.Observation.Bird.EnglishName <small><i> @Model.Observation.Bird.Species</i></small></h1>
<h4>Observed on @Html.DisplayFor(modelItem => Model.Observation.ObservationDateTime)</h4>
<hr />
<div class="row">
    <div class="col-md-12">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Observation.ObservationId" />
            <input asp-for="Observation.LocationLatitude" id="latitude" />
            <input asp-for="Observation.LocationLongitude" id="longitude" />
            @*<div class="form-group">
            <input class="form-control" name="Observation.LocationLatitude" data-bind="value: Observation.LocationLatitude" id="latitude" />
            <input class="form-control" name="Observation.LocationLongitude" data-bind="value: Observation.LocationLongitude" id="longitude" />
        </div>*@

            <div>
                <div class="row">
                    <div class="col-sm-4">
                    </div>
                    <div class="col-sm-8">
                        <button class="btn btn-link" type="button" onclick="expand()" style="float: right;">Expand All</button>
                        <button class="btn btn-link" type="button" onclick="collapse()" style="float: right;">Collapse All</button>
                    </div>
                </div>
                <div class="panel-group" id="accordion">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse0"><b>General</b></a>
                            </h4>
                        </div>
                        <div id="collapse0" class="panel-collapse collapse in">
                            <div class="panel-body">
                                <div class="form-group">
                                    <label asp-for="Observation.ObservationDateTime" class="control-label"></label>
                                    <input asp-for="Observation.ObservationDateTime" class="form-control" />
                                    <span asp-validation-for="Observation.ObservationDateTime" class="text-danger"></span>
                                </div>
                                <div class="form-group">
                                    <label asp-for="Observation.Quantity" class="control-label"></label>
                                    <input asp-for="Observation.Quantity" class="form-control" />
                                    <span asp-validation-for="Observation.Quantity" class="text-danger"></span>
                                </div>
                                <div class="form-group">
                                    <label asp-for="Observation.BirdId" class="control-label"></label>
                                    @*<select asp-for="Observation.BirdId" class="form-control" asp-items="ViewBag.BirdId"></select>*@
                                    @Html.DropDownListFor(m => m.Observation.BirdId,
                  new SelectList(Model.Birds, "BirdId", "EnglishName"),
                  new
                  {
                      @name = "BirdId",
                      @class = "form-control selectpicker showtick",
                                         //data_bind = "attr: {'Id': 'BirdId_' + $index()}, selectPicker: {}, value: BirdId",
                                         title = "Choose a bird species...",
                      data_live_search = "true",
                      data_show_subtext = "true"
                  })
                                    <span asp-validation-for="Observation.BirdId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse1"><b>@Html.DisplayNameFor(model => model.Observation.NoteGeneral)</b></a>
                            </h4>
                        </div>
                        <div id="collapse1" class="panel-collapse collapse in">
                            <div class="panel-body">
                                @Html.DisplayFor(model => model.Observation.NoteGeneral)
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse2"><b>@Html.DisplayNameFor(model => model.Observation.NoteHabitat)</b></a>
                            </h4>
                        </div>
                        <div id="collapse2" class="panel-collapse collapse">
                            <div class="panel-body">
                                @Html.DisplayFor(model => model.Observation.NoteHabitat)
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse3"><b>@Html.DisplayNameFor(model => model.Observation.NoteWeather)</b></a>
                            </h4>
                        </div>
                        <div id="collapse3" class="panel-collapse collapse">
                            <div class="panel-body">
                                @Html.DisplayFor(model => model.Observation.NoteWeather)
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse4"><b>@Html.DisplayNameFor(model => model.Observation.NoteAppearance)</b></a>
                            </h4>
                        </div>
                        <div id="collapse4" class="panel-collapse collapse">
                            <div class="panel-body">
                                @Html.DisplayFor(model => model.Observation.NoteAppearance)
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse5"><b>@Html.DisplayNameFor(model => model.Observation.NoteBehaviour)</b></a>
                            </h4>
                        </div>
                        <div id="collapse5" class="panel-collapse collapse">
                            <div class="panel-body">
                                @Html.DisplayFor(model => model.Observation.NoteBehaviour)
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse6"><b>@Html.DisplayNameFor(model => model.Observation.NoteVocalisation)</b></a>
                            </h4>
                        </div>
                        <div id="collapse6" class="panel-collapse collapse">
                            <div class="panel-body">
                                @Html.DisplayFor(model => model.Observation.NoteVocalisation)
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" @*data-parent="#accordion" *@ href="#collapse7"><b>Location</b></a>
                            </h4>
                        </div>
                        <div id="collapse7" class="panel-collapse collapse in">
                            <div class="panel-body">
                                <div class="form-group">
                                    <label class="control-label">Observation location (use the map control to set the location):</label>
                                    <input class="form-control" id="set" disabled />
                                    <div class="container" id="floating-panel">
                                        <input id="address" type="text" value="">
                                        <input id="submit" type="button" value="Search">
                                    </div>
                                </div>
                                <div id="map" class="class--map"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="form-group">
                <label asp-for="Observation.NoteGeneral" class="control-label"></label>
                <input asp-for="Observation.NoteGeneral" class="form-control" />
                <span asp-validation-for="Observation.NoteGeneral" class="text-danger"></span>
            </div>


            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-default" />
            </div>
        </form>
</div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

<script>
    function expand() {
        $('.panel-collapse').collapse('show');
    }
    function collapse() {
        $('.panel-collapse').collapse('hide');
    }

    var markers = [];

    function initMap() {
        var myLatlng = new google.maps.LatLng(@Model.Observation.LocationLatitude,@Model.Observation.LocationLongitude);
        var myOptions = {
            zoom: 13,
            center: myLatlng,
        }

        var map = new google.maps.Map(document.getElementById("map"), myOptions);
        var geocoder = new google.maps.Geocoder();

        //google.maps.event.addListenerOnce(map, 'idle', addMarker(myLatlng));
        google.maps.event.addListenerOnce(map, 'idle', function (event) {
            geocoder.geocode({
                'latLng': myLatlng
            }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        //alert(results[0].formatted_address);
                        document.getElementById('set').value = results[0].formatted_address
                        addMarker(results[0].geometry.location);
                    }
                }
            });
        });

        document.getElementById('submit').addEventListener('click', function (event) {
            var address = document.getElementById('address').value;
            geocoder.geocode({
                'address': address
            }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        //alert(results[0].formatted_address);
                        document.getElementById('set').value = results[0].formatted_address
                        addMarker(results[0].geometry.location);
                    }
                }
            });
        });

        google.maps.event.addListener(map, 'click', function (event) {
            geocoder.geocode({
                'latLng': event.latLng
            }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        //alert(results[0].formatted_address);
                        document.getElementById('set').value = results[0].formatted_address
                        addMarker(event.latLng);
                    }
                }
            });
        });

        function addMarker(location) {
            var marker = new google.maps.Marker({
                position: location,
                map: map,
            });

            map.panTo(location);
            deleteMarkers();
            markers.push(marker);
            updateForm();
        }

        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        // Shows any markers currently in the array.
        function showMarkers() {
            setMapOnAll(map);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }
        function updateForm() {
            createObservationViewModel.Observation.LocationLatitude(markers[0].position.lat());
            createObservationViewModel.Observation.LocationLongitude(markers[0].position.lng());
        }
    }
</script>
